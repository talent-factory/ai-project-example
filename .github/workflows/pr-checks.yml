name: Pull Request Checks

# LÃ¤uft bei jedem PR auf main/develop
on:
  pull_request:
    branches:
      - main
      - develop

jobs:
  # Basis-Checks fÃ¼r alle PRs
  basic-checks:
    name: Basis-Validierung
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: PrÃ¼fe Commit-Messages
        run: |
          echo "PrÃ¼fe Commit-Message-Format..."
          # Beispiel: PrÃ¼fe ob Emoji Conventional Commit verwendet wird
          git log --format=%s -1 | grep -E "^(âœ¨|ğŸ›|ğŸ“š|ğŸ’|â™»ï¸|âš¡|ğŸ§ª|ğŸ”§|ğŸš€|ğŸ”’|ğŸŒ|ğŸ¨|ğŸ”¥|ğŸš‘|ğŸ’š|â¬†ï¸|â¬‡ï¸|ğŸ“Œ|â•|â–|ğŸ”–|ğŸš§)" || \
          echo "âš ï¸ Warnung: Commit-Message folgt nicht dem Emoji-Format"

      - name: PrÃ¼fe auf Secrets
        run: |
          echo "PrÃ¼fe auf versehentlich committete Secrets..."
          # Einfache PrÃ¼fung auf hÃ¤ufige Secret-Muster
          ! grep -r "api_key\s*=\s*['\"]" . --include="*.py" --include="*.js" --include="*.ts" || \
          (echo "âŒ Warnung: MÃ¶glicherweise Secrets im Code gefunden" && exit 1)

      - name: PrÃ¼fe .gitignore
        run: |
          echo "PrÃ¼fe ob .gitignore vorhanden ist..."
          test -f .gitignore || (echo "âŒ .gitignore fehlt" && exit 1)
          echo "âœ… .gitignore vorhanden"

  # Command-Validierung (falls Commands geÃ¤ndert wurden)
  validate-commands:
    name: Command-Validierung
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: PrÃ¼fe Command-Struktur
        run: |
          echo "PrÃ¼fe Command-Dateien..."
          # PrÃ¼fe ob alle Commands YAML-Frontmatter haben
          for file in .claude/commands/**/*.md; do
            if [ -f "$file" ]; then
              head -1 "$file" | grep -q "^---$" || \
              echo "âš ï¸ Warnung: $file hat kein YAML-Frontmatter"
            fi
          done
          echo "âœ… Command-Struktur-Check abgeschlossen"

      - name: PrÃ¼fe Agent-Struktur
        run: |
          echo "PrÃ¼fe Agent-Dateien..."
          # PrÃ¼fe ob alle Agents YAML-Frontmatter haben
          for file in .claude/agents/**/*.md; do
            if [ -f "$file" ]; then
              head -1 "$file" | grep -q "^---$" || \
              echo "âš ï¸ Warnung: $file hat kein YAML-Frontmatter"
            fi
          done
          echo "âœ… Agent-Struktur-Check abgeschlossen"

  # Markdown-Validierung
  markdown-lint:
    name: Markdown Linting
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Markdown Lint
        uses: DavidAnson/markdownlint-cli2-action@v15
        with:
          globs: |
            **/*.md
            !node_modules
            !.plans
          fix: false
        continue-on-error: true  # Nur Warnung, kein Fehler

  # Python-Checks (falls Python-Code vorhanden)
  python-checks:
    name: Python-Validierung
    runs-on: ubuntu-latest
    if: contains(github.event.pull_request.changed_files, '.py')

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Ruff
        run: pip install ruff

      - name: Ruff Check
        run: ruff check . --output-format=github
        continue-on-error: true

      - name: Ruff Format Check
        run: ruff format --check .
        continue-on-error: true

  # Node.js-Checks (falls JavaScript/TypeScript vorhanden)
  nodejs-checks:
    name: Node.js-Validierung
    runs-on: ubuntu-latest
    if: contains(github.event.pull_request.changed_files, '.js') || contains(github.event.pull_request.changed_files, '.ts')

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: |
          if [ -f package.json ]; then
            npm ci
          else
            echo "Kein package.json gefunden, Ã¼berspringe..."
          fi
        continue-on-error: true

      - name: ESLint
        run: |
          if [ -f package.json ] && grep -q "eslint" package.json; then
            npm run lint
          else
            echo "ESLint nicht konfiguriert, Ã¼berspringe..."
          fi
        continue-on-error: true

  # PR-Size-Check
  pr-size-check:
    name: PR-GrÃ¶ÃŸe prÃ¼fen
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: PrÃ¼fe PR-GrÃ¶ÃŸe
        run: |
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | wc -l)
          CHANGED_LINES=$(git diff --stat origin/${{ github.base_ref }}...HEAD | tail -1 | awk '{print $4+$6}')

          echo "GeÃ¤nderte Dateien: $CHANGED_FILES"
          echo "GeÃ¤nderte Zeilen: $CHANGED_LINES"

          if [ "$CHANGED_FILES" -gt 50 ]; then
            echo "âš ï¸ Warnung: PR ist groÃŸ ($CHANGED_FILES Dateien). ErwÃ¤ge Aufteilung in kleinere PRs."
          fi

          if [ "$CHANGED_LINES" -gt 1000 ]; then
            echo "âš ï¸ Warnung: PR ist groÃŸ ($CHANGED_LINES Zeilen). ErwÃ¤ge Aufteilung in kleinere PRs."
          fi

# Alle Checks mÃ¼ssen erfolgreich sein (auÃŸer continue-on-error)
